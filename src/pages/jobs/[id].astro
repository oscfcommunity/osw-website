---
import { getCollection } from 'astro:content';
import Container from '../../components/layout/Container.astro';
import Layout from '../../layouts/Layout.astro';
import JobDetailHeader from '../../components/jobs/JobDetailHeader.astro';
import JobDescription from '../../components/jobs/JobDescription.astro';
import JobApplicationCard from '../../components/jobs/JobApplicationCard.astro';
import JobDetailsCard from '../../components/jobs/JobDetailsCard.astro';
import JobCompanyCard from '../../components/jobs/JobCompanyCard.astro';

// Required by Astro for dynamic routes
export const getStaticPaths = async () => {
  const jobs = await getCollection('jobs');
  return jobs
    .filter(j => j.data?.status === 'ACTIVE')
    .map(j => ({ params: { id: j.id }, props: { job: j } }));
};

const job = (Astro.props && Astro.props.job) || null;

// Calculate days until expiration (always a number)
const daysUntilExpiration = job?.data?.validThrough
  ? Math.max(
      0,
      Math.ceil(
        (new Date(job.data.validThrough).getTime() - Date.now()) /
          (1000 * 60 * 60 * 24)
      )
    )
  : 0;
---

<Layout
  title={`${job.data.title} at ${job.data.company.name} - OSW Jobs`}
  description={job.data.description.substring(0, 160)}
>
  <main class="min-h-screen bg-base-100">
    {/* Header Section */}
    <section class="py-12 bg-base-200">
      <Container>
        <JobDetailHeader job={job} daysUntilExpiration={daysUntilExpiration} />
      </Container>
    </section>

    {/* Main Content */}
    <section class="py-12">
      <Container>
        <div class="max-w-4xl mx-auto">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Left Column - Job Details */}
            <div class="lg:col-span-2 space-y-6">
              <JobDetailsCard job={job} />
              <JobDescription job={job} />
            </div>

            {/* Right Column - Job Info & Apply */}
            <div class="lg:col-span-1">
              <div class="sticky top-4 space-y-6">
                {/* Apply Card */}
                <JobApplicationCard application={job.data.application} />

                {/* Company Info Card */}
                <JobCompanyCard company={job.data.company} />
              </div>
            </div>
          </div>
        </div>
      </Container>
    </section>

    {/* Related Jobs Section */}
    <section class="py-12 bg-base-200">
      <Container>
        <div class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl font-bold mb-4">Explore More Opportunities</h2>
          <p class="text-base-content/70 mb-8">
            Check out other positions that might interest you
          </p>
          <a href="/jobs" class="btn btn-primary btn-lg"> View All Jobs </a>
        </div>
      </Container>
    </section>
  </main>
</Layout>
